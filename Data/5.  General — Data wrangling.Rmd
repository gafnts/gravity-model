# General data wrangling

```{r}
pacman::p_load(tidyverse, magrittr, here)
```

## 1 --- Trade flows database

### Loading exports and imports

```{r}
# Exports
setwd(here("Data", "Exports raw"))

exports_raw <- 
  dir(pattern = "*.rds") %>% 
  map(read_rds) %>% 
  reduce(bind_rows)

# Imports
setwd(here("Data", "Imports raw"))

imports_raw <-
  dir(pattern = "*.rds") %>%
  map(read_rds) %>%
  reduce(bind_rows)

setwd(here())
```

### Binding and cleaning

```{r}
trade <- 
  bind_rows(exports_raw, imports_raw) %>% 
  select_if(~ !any(is.na(.))) %>% 
  select(-c(classification, period, period_desc, 
            is_leaf_code, trade_flow_code, flag, 
            aggregate_level, reporter_code, partner_code)) %>% 
  group_by(trade_flow) %>% 
  arrange(year, trade_flow, partner, commodity) %>% 
  mutate(partner = case_when(
    partner == "Dominican Rep." ~ "Dominican Republic",
    partner == "Bolivia (Plurinational State of)" ~ "Bolivia",
    TRUE ~ partner
  )) %>% 
  ungroup()
```

### Writing tibble

```{r}
write_csv(trade, file = paste0(here("Data", "Main data frames"), "/trade_flows.csv"))
```

## 2 --- Partner names dataframe

### Loading ISO codes from Github

UN geoscheme: <https://en.wikipedia.org/wiki/United_Nations_geoscheme#Americas>

```{r}
codes <-
  read_csv("https://git.io/v564u") %>%
  select(partner = name,
         partner_iso = `alpha-3`,
         subregions = `sub-region`,
         int_region = `intermediate-region`) %>% 
  mutate(partner = case_when(
    partner == "Venezuela (Bolivarian Republic of)" ~ "Venezuela", 
    partner == "Bolivia (Plurinational State of)" ~ "Bolivia",
    TRUE ~ partner 
  ))
```

### Joining with country names in the trade dataframe

```{r}
names <- 
  tribble(~partner,
        # Central America and Mexico
        "Belize", "Costa Rica", "Panama", "Honduras",
        "Nicaragua", "El Salvador", "Mexico",
        
        # South America
        "Argentina", "Bolivia",  "Brazil", "Chile",
        "Colombia", "Ecuador", 
        # "Venezuela", 
        "Guyana",
        "Paraguay", "Peru", "Uruguay", "Suriname",
        
        # Caribbean
        "Dominican Republic", 
        #"Cuba", 
        "Haiti", "Trinidad and Tobago",
        "Dominica", "Grenada", "Jamaica", "Barbados",
        "Bahamas", "Saint Vincent and the Grenadines", 
        "Saint Lucia")

countries <- 
  codes %>% 
  inner_join(names, by = "partner") %>% 
  arrange(partner, int_region)
```

### Writing tibble

```{r}
write_csv(countries, file = paste0(here("Data", "Main data frames"), "/partners_names.csv"))
```

### Join example

```{r}
trade %>% left_join(countries, by = c("partner_iso", "partner"))
```

## 3 --- Macro variables database

### Import dataframes

```{r}
iso <- countries |> pull(partner_iso)

partners <- 
  read_csv(here("Data", "World Bank raw", "partners_wdi.csv")) |> 
  select(year:iso3c, capital:latitude) |> 
  rename("partner_iso" = iso3c) |> 
  filter(partner_iso %in% iso) |> 
  select(!c(status, lastupdated, capital, longitude, latitude)) |> 
  relocate(year, partner_iso, everything())
```

Adding exchange rate for HND based on: <https://fred.stlouisfed.org/series/FXRATEHNA618NUPN>

(Penn World Table 7.1)

```{r}
hnd <- tibble(year = 1995:1999,
              partner_iso = "HND",
              exchange = c(9.470986667, 11.7053025,
                           13.00347417, 13.385015,
                           14.21316833))

partners <- 
  partners |> 
  rows_update(hnd, by = c("year", "partner_iso"))
```

```{r}
guatemala <- 
  read_csv(here("Data", "World Bank raw", "guatemala_wdi.csv")) |> 
  select(year:iso3c, capital:latitude) |> 
  rename("reporter_iso" = iso3c) |> 
  select(!c(status, lastupdated, capital, longitude, latitude)) |> 
  relocate(year, reporter_iso, everything())
```

### Writing tibbles

```{r}
write_csv(partners, file = paste0(here("Data", "Main data frames"), "/partners_macro.csv"))
write_csv(guatemala, file = paste0(here("Data", "Main data frames"), "/gtm_macro.csv"))
```
