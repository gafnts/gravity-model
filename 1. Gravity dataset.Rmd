# Gravity dataset

```{r}
pacman::p_load(tidyverse, magrittr, here)
```

## 1 --- Basic dataset

### Importing dataframes

```{r}
trade_flows <- read_csv(here("Data", "Main data frames", "trade_flows.csv"))
transaction_costs <- read_csv(here("Data", "Main data frames", "transaction_costs.csv"))
gtm_macro <- read_csv(here("Data", "Main data frames", "gtm_macro.csv"))
partners_macro <- read_csv(here("Data", "Main data frames", "partners_macro.csv"))
partners_names <- read_csv(here("Data", "Main data frames", "partners_names.csv"))
```

### Data wrangling

```{r}
# Total trade flows (by exports)
total_exports <- 
  trade_flows %>% 
  filter(trade_flow == "Export") %>% 
  group_by(year, partner_iso) %>% 
  summarise(trade_value = sum(trade_value_usd)) %>% 
  ungroup()
```

### Data visualization

```{r}
total_exports %>% 
  ggplot(aes(year, trade_value)) +
  geom_line() +
  facet_wrap(~ partner_iso, scales = "free")
```

**Observations:**

There is no data available in the Comtrade database for KNA (1995-2000) and ATG (1995-2000).\
Do I have to separate ARG/BOL from BRA/CHL in imports data extraction?

**Notes:**

Note that after adding the trade flows by year, there are only 766 observations, instead of the 806 that should be. Do these zeros reflect the lack of trade flows in specific years?

```{r}
# These are the countries and years for which we don't have trade flows
transaction_costs %>% anti_join(trade_flows) %>% View

# Remove VEN from trade flows data frame
trade_flows %>% anti_join(transaction_costs) %>% View
```

```{r}
# Join transaction costs with trade flows
gravity_raw <- 
  trade_flows %>% 
  left_join(transaction_costs) %>% 
  arrange(partner_iso) %>% 
  filter(!str_detect(partner_iso, "VEN|BOL")) %>% 
  select(year:dist, cont:ccol, rta)
```

```{r}
# Clean macro data for country i
gtm_macro %<>% 
  select(year, 
         reporter_iso,
         i_gdp = gdp,
         i_gdp_pcap = gdp_pcap)

# Join with gravity raw
gravity_raw %<>% 
  left_join(gtm_macro)

# Clean macro data for countries j
partners_macro %<>% 
  select(year, 
         partner_iso,
         j_gdp = gdp,
         j_gdp_pcap = gdp_pcap)

# Join with gravity raw
gravity <- 
  gravity_raw %>% 
  left_join(partners_macro)
```

Note: It appears that some countries time series don't end in 2019. ARG, for example. Fix that.

### Cleaning basic dataset

I think a lot of data wragling needs to be done before we can estimate the actual model. But the last few hours where very productive! Going forward it's gonna be necessary to create a looped function that let me make sure all countries have the number of rows needed. It will be vital for more complex dataframes coming up.

```{r}
# Extract partners names
names <- 
  gravity %>% 
  distinct(partner_iso) %>% 
  as.list()

countries <- 
  names$partner_iso

# How many observations are there per partner?
rows <- 
  tibble(countries = countries)

for(i in countries) {
  rows[[i]] <- gravity %>% filter(partner_iso == i) %>% nrow()
}

rows %<>% 
  slice(1) %>% 
  pivot_longer(cols = (2:length(rows))) %>% 
  select(-countries)

# Pull only the partners with complete observations
complete <- 
  rows %>% filter(value == 26) %>% pull(1)
```

```{r}
# Gravity db with only complete partners
gravity %<>% filter(partner_iso %in% complete)

# How many partners does the db have?
gravity %>% distinct(partner_iso) %>% dim()
```

## 2 --- Incomplete and badly specified gravity model estimation

```{r}
pacman::p_load(panelr, plm, broom)
```

$$
X_{ij}=G\frac{Y_{i}^{\beta_{1}}Y_{j}^{\beta_{2}}}{t_{ij}^{\beta_{3}}}.
$$

```{r}
panel <- panel_data(gravity, id = partner_iso, wave = year)
```

```{r}
# Fixed effects
fit <- plm(log(trade_value) ~ log(i_gdp) + log(j_gdp) + log(dist),
           data = gravity,
           index = c("partner_iso", "year"),
           model = "within")

summary(fit)
```
