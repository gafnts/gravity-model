# Gravity dataset

```{r}
pacman::p_load(tidyverse, magrittr, here, plotly)
```

```{r}
partners_names <- read_csv(here("Data", "Main data frames", "partners_names.csv"))
trade_flows <- read_csv(here("Data", "Main data frames", "trade_flows.csv"))
transaction_costs <- read_csv(here("Data", "Main data frames", "transaction_costs.csv"))
gtm_macro <- read_csv(here("Data", "Main data frames", "gtm_macro.csv"))
partners_macro <- read_csv(here("Data", "Main data frames", "partners_macro.csv"))
```

## 1 --- Gravity variables

$$
TGDP_{ij,t} = GDP_{i,t} + GDP_{j,t} \\
RFE_{ij, t} = \Bigg| ln\Bigg(\frac{GDP_{i, t}}{N_{i, t}}\Bigg) - ln\Bigg(\frac{GDP_{j, t}}{N_{j, t}}\Bigg) \Bigg| \\
SIM_{ij, t} = 1 - \Big(\frac{ln(GDP_{i, t})}{ln(GDP_{i, t}+GDP_{j, t})}\Big)^2 - \Big(\frac{ln(GDP_{j, t})}{ln(GDP_{i, t}+GDP_{j, t})}\Big)^2 \\
RER_{ij, t} = \bigg(\frac{LC_{i, t}}{LC_{j, t}}\bigg)\bigg(\frac{P_{j, t}}{P_{i, t}}\bigg)
$$

```{r}
macro <- 
  gtm_macro |> 
  left_join(partners_macro, by = "year", suffix = c("_i", "_j")) |> 
  arrange(partner_iso, year) |> 
  group_by(partner_iso) |> 
  mutate(
    tgdp = gdp_i + gdp_j,
    rfe = abs(log(gdp_i/population_i) - log(gdp_j/population_j)),
    sim = 1 - ((log(gdp_i)/log(gdp_i + gdp_j))^2 - (log(gdp_j)/log(gdp_i + gdp_j))^2),
    rer = (exchange_i/exchange_j) * (deflator_j/deflator_i)
  ) |> 
  ungroup()
```

## 2 --- Total flows

### Exports

```{r}
total_exports <- 
  trade_flows |> 
  filter(trade_flow == "Export") |> 
  group_by(year, partner_iso) |> 
  summarise(trade_value = sum(trade_value_usd)) |> 
  ungroup() |> 
  arrange(partner_iso)
```

```{r}
# Countries and years for which there are zero trade flows
transaction_costs |> anti_join(total_exports) |> print(n = Inf)
```

```{r}
exports <- 
  transaction_costs |> 
  left_join(total_exports) |> 
  select(year:partner_iso, trade_value, everything()) |> 
  mutate(across(where(is.numeric), ~ replace(., is.na(.), 0))) |> 
  left_join(macro,
            by = c("year", "reporter_iso", "partner_iso")) |> 
  rename("iso_i" = reporter_iso, "iso_j" = partner_iso, "exports" = trade_value)
```

### Imports

```{r}
total_imports <- 
  trade_flows |> 
  filter(trade_flow == "Import") |> 
  group_by(year, partner_iso) |> 
  summarise(trade_value = sum(trade_value_usd)) |> 
  ungroup() |> 
  arrange(partner_iso)
```

```{r}
# There are 80 zeros in the total_import data set
transaction_costs |> anti_join(total_imports) |> print(n = Inf)
```

```{r}
imports <- 
  transaction_costs |> 
  left_join(total_imports) |> 
  select(year:partner_iso, trade_value, everything()) |> 
  mutate(across(where(is.numeric), ~ replace(., is.na(.), 0))) |> 
  left_join(macro,
            by = c("year", "reporter_iso", "partner_iso")) |> 
  rename("iso_i" = reporter_iso, "iso_j" = partner_iso, "imports" = trade_value)
```

## 3 --- Final data set

```{r}
gravity <- 
  exports |> 
  select(exports) |>
  bind_cols(imports) |> 
  select(year:iso_j, exports, imports, everything()) |> 
  drop_na() |> 
  write_csv("gravity.csv")
```
