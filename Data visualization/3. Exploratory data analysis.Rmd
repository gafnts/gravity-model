# Exploratory data anaylisis

```{r}
pacman::p_load(tidyverse, here, sf, patchwork)
```

### Export/Import maps

(a) Filter 0's before applying logs

(b) Make title font bigger

```{r}
gravity <- read_csv(here("gravity.csv"))
codes <- read_csv("https://git.io/v564u") |> select(country = name, iso_j = `alpha-3`)
mapdata <- map_data("world") %>% as_tibble() |> rename(country = region)
```

```{r}
gravity_map <- 
  gravity |> 
  group_by(iso_j) |> 
  mutate(exports = mean(log(exports)),
         imports = mean(log(imports))) |> 
  filter(year == 2020) |> 
  select(iso_j, exports, imports) |> 
  left_join(codes) |> 
  relocate(country) |> 
  rename(iso = iso_j) |> 
  ungroup() |> 
  mutate(country = case_when(
    country == "United States of America" ~ "USA",
    country == "Bolivia (Plurinational State of)" ~ "Bolivia",
    country == "Trinidad and Tobago" ~ "Trinidad",
    country == "Saint Vincent and the Grenadines" ~ "Saint Vincent",
    TRUE ~ country
  )) |> 
  right_join(mapdata)
```

```{r}
map_aesthetics <- function(val, ...) {
    theme(
      plot.title = element_text(size = 20),
      axis.title = element_blank(),
      axis.ticks = element_blank(),
      axis.text = element_blank(),
      legend.position = "bottom",
      legend.key.width = unit(val, "line"),
      legend.title = element_blank(),
      panel.background = element_rect(fill = "gray95"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank()
    )
}
```

```{r}
p1 <- 
  gravity_map |> 
  ggplot(aes(x = long, y = lat, group = group)) +
  geom_polygon(aes(fill = exports), color = "white", size = .1) +
  coord_cartesian(xlim = c(-170, -35), ylim = c(-55, 82)) +
  scale_fill_gradientn(colours = c("#91C4D9", "gray80", 2),
                     values = scales::rescale(c(-0.1, -0.05, 0, 0.05, 0.1)),
                     na.value = "gray30") +
  ggtitle("Promedio del logartimo de exportaciones\ndurante el periodo de análisis por país de destino") +
  map_aesthetics(val = 7.6)

p2 <- 
  gravity_map |> 
  ggplot(aes(x = long, y = lat, group = group)) +
  geom_polygon(aes(fill = imports), color = "white", size = .1) +
  coord_cartesian(xlim = c(-170, -35), ylim = c(-55, 82)) +
  scale_fill_gradientn(colours = c("#91C4D9", "gray80", 2),
                     values = scales::rescale(c(-0.1, -0.05, 0, 0.05, 0.1)),
                     na.value = "gray30") +
  ggtitle("Promedio del logartimo de importaciones\ndurante el periodo de análisis por país de origen") +
  map_aesthetics(val = 7.6)

p1 + p2
```

```{r}
ggsave(here("Data visualization", "Plots", "maps.png"), 
       width = 16, height = 12, dpi = 300, units = "in")
```
