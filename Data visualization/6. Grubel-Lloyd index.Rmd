# Grubel-Lloyd index

```{r}
pacman::p_load(tidyverse, here)
gravity <- read_csv(here("gravity.csv")) |> select(year, iso_j, sim)
```

```{r}
trade_flows <- 
  read_csv(here("Data", "Main data frames", "trade_flows.csv")) |> 
  select(year, trade_flow, partner_iso, commodity, 
         commodity_code, value = trade_value_usd) |> 
  filter(partner_iso != "CUB")
```

#### Grubel-Lloyd index over time

Filter only industrial commodity codes

$$
GL_i = \frac{(X_i + M_i) - |X_i - M_i|}{X_i + M_i} = 1 - \frac{|X_i - M_i|}{X_i + M_i}
$$

```{r}
gl <- 
  trade_flows |> 
  pivot_wider(names_from = trade_flow, values_from = value) |> 
  mutate(across(where(is.numeric), ~ replace_na(., 0))) |> 
  group_by(year, commodity, commodity_code) |> 
  summarise(export = sum(Export),
            import = sum(Import)) |> 
  mutate(index = 1 - (abs(export - import) / (export + import))) |> 
  select(year, commodity, commodity_code, index)
```

```{r}
gl |> 
  group_by(year) |> 
  summarise(index = mean(index)) |> 
  ggplot(aes(year, index)) +
  geom_line()
```

#### GL index and SIM index

```{r}
gl_partner <- 
  trade_flows |> 
  pivot_wider(names_from = trade_flow, values_from = value) |> 
  mutate(across(where(is.numeric), ~ replace_na(., 0))) |> 
  group_by(year, partner_iso, commodity) |> 
  summarise(export = sum(Export),
            import = sum(Import)) |> 
  mutate(gl = 1 - (abs(export - import) / (export + import))) |> 
  select(year, partner_iso, commodity, gl) |> 
  group_by(partner_iso) |> 
  summarise(gl = mean(gl)) |> 
  rename(iso_j = partner_iso)

sim_partner <- 
  gravity |> 
  group_by(iso_j) |> 
  summarise(sim = mean(sim))

index <- 
  gl_partner |> 
  left_join(sim_partner)
```

```{r}
index |> 
  ggplot(aes(sim, gl)) +
  geom_point(position = position_jitter()) +
  geom_smooth(method = lm, formula = y ~ splines::ns(x, 4), se = TRUE) +
  geom_text(aes(label = iso_j),
            nudge_y = .005)
```
