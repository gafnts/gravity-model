# Principal component analysis

```{r}
pacman::p_load(tidyverse, tidymodels, here, factoextra)

flows <- 
  read_csv(here("Data", "Main data frames", "trade_flows.csv")) |> 
  select(year, trade_flow, partner_iso, commodity_code, commodity, trade_value_usd)
```

```{r}
flows <- 
  flows |> 
  mutate(commodity_code = str_extract(commodity_code, "^\\d{2}")) |> 
  mutate(hs = case_when(
    between(commodity_code, 1, 5) ~ "Animales y productos derivados",
    between(commodity_code, 6, 15) ~ "Productos vegetales",
    between(commodity_code, 16, 24) ~ "Alimentos preparados",
    between(commodity_code, 25, 27) ~ "Productos minerales",
    between(commodity_code, 28, 38) ~ "Productos químicos",
    between(commodity_code, 39, 40) ~ "Plásticos y sus manufacturas",
    between(commodity_code, 41, 43) ~ "Cueros, pieles y sus manufacturas",
    between(commodity_code, 44, 49) ~ "Madera y productos derivados",
    between(commodity_code, 50, 63) ~ "Textiles y artículos derivados",
    between(commodity_code, 64, 67) ~ "Calzado, sombreros y sombrillas",
    between(commodity_code, 68, 71) ~ "Artículos de piedra, cerámica y vidrio",
    between(commodity_code, 72, 83) ~ "Metales y artículos derivados",
    between(commodity_code, 84, 85) ~ "Maquinaria y equipo eléctrico",
    between(commodity_code, 86, 89) ~ "Vehículos y equipo asociado",
    between(commodity_code, 90, 97) ~ "Artículos misceláneos manufacturados",
    TRUE ~ "No especificados"
  ))
```

#### Biplot

```{r}
exports <- 
  flows |> 
  filter(trade_flow == 'Export') |> 
  select(!c(commodity_code, commodity)) |> 
  group_by(partner_iso, hs) |> 
  summarise(mean = mean(trade_value_usd)) |> 
  pivot_wider(names_from = hs, values_from = mean) |> 
  mutate_all(~ replace(., is.na(.), 0)) |> 
  column_to_rownames('partner_iso')

biplot <- 
  fviz_pca_biplot(
    prcomp(exports, center = TRUE, scale. = TRUE), repel = TRUE,
    col.var = "#2E9FDF", # Variables color
    col.ind = "#696969"  # Individuals color
)

biplot + ggtitle('Title')
```

#### Tidy way

```{r}
exports <- 
  flows |> 
  filter(trade_flow == 'Export') |> 
  select(!c(commodity_code, commodity)) |> 
  group_by(partner_iso, hs) |> 
  summarise(mean = mean(trade_value_usd)) |> 
  pivot_wider(names_from = hs, values_from = mean) |> 
  mutate_all(~ replace(., is.na(.), 0))

pca_exports <- 
  recipe(~., data = exports) |> 
  update_role(partner_iso, new_role = 'id') |> 
  step_normalize(all_predictors()) |> 
  step_pca(all_predictors())

prep_exports <- prep(pca_exports)
tidy_exports <- tidy(prep_exports, 2)

tidy_exports |> 
  filter(component %in% paste0('PC', 1:2)) |> 
  mutate(component = fct_inorder(component)) |> 
  ggplot(aes(value, terms, fill = terms)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~component, nrow = 1) +
  labs(y = NULL)

juice(prep_exports) %>%
  ggplot(aes(PC1, PC2, label = partner_iso)) +
  geom_point(alpha = 0.7, size = 2) +
  geom_text(check_overlap = TRUE, hjust = "inward") +
  labs(color = NULL)
```

sthda: <http://www.sthda.com/english/articles/31-principal-component-methods-in-r-practical-guide/118-principal-component-analysis-in-r-prcomp-vs-princomp/>

julia: <https://juliasilge.com/blog/cocktail-recipes-umap/>\
