# Coefficients evolution over time

```{r}
pacman::p_load(tidyverse, broom, here, janitor, panelr, plm, lmtest, patchwork)
gravity <- read_csv("gravity.csv")
```

```{r}
# Feature engineering
exports_data <- 
  gravity |> 
  mutate(exports = ifelse(log(exports) <= 0, 0, log(exports))) |> 
  panel_data(id = iso_j, wave = year)

imports_data <- 
  gravity |> 
  mutate(imports = ifelse(log(imports) <= 0, 0, log(imports))) |> 
  panel_data(id = iso_j, wave = year)
```

```{r}
# Declaring formulas
exports_formula <- 
  exports ~ tgdp + rfe + sim + log(dist) + cont + lang + ccol + crel + rta

imports_formula <- 
  imports ~ tgdp + rfe + sim + log(dist) + cont + lang + ccol + crel + rta
```

```{r}
extract <- function(data, formula, date) {
  filtered_data <- data |> filter(year == date)
  
  model <-
    glm(formula,
        family = quasipoisson(link = "log"),
        data = filtered_data)
  
  tidy <- model |> tidy() |> mutate(year = date) |> relocate(year) |> select(!4:6)
  
  std <- 
    coeftest(model, vcov = vcovHC, type = "HC1", cluster = "group")[, 2] |> 
    as_tibble() |> 
    rename(std.error = value)
  
  result <- tidy |> bind_cols(std)
  return(result)
}
```

```{r}
dates <- c(1995:2020)

exports <- tibble()

for (date in dates) {
  extraction <- extract(exports_data, exports_formula, date)
  exports <- bind_rows(exports, extraction)
}

imports <- tibble()

for (date in dates) {
  extraction <- extract(imports_data, imports_formula, date)
  imports <- bind_rows(imports, extraction)
}
```

```{r}
spline_plot <- function(data, spline) {
  data |> 
    filter(term %in% c("rfe", "sim")) |> 
    ggplot(aes(year, estimate, color = term)) +
    geom_point(color = "gray15") +
    facet_wrap(vars(term), scales = "free") +
    geom_smooth(color = "#4E74BF", fill = "#4E74BF", alpha = .1,
                method = lm, formula = y ~ splines::bs(x, spline)) +
    scale_y_continuous() +
    theme(
      text = element_text(color = "gray15", 
                          family = "Helvetica Neue",
                          size = 19),
      axis.title = element_blank(),
      axis.text = element_text(color = "gray15"),
      axis.ticks = element_blank(),
      legend.title = element_blank(),
      legend.position = "none",
      legend.key = element_rect(fill = "white"),
      legend.background = element_rect(color = "gray15", size = 0.25),
      panel.background = element_rect(color = "gray15", fill = "white"),
      panel.grid = element_blank(),
      strip.background = element_rect(color = "gray15", fill = "gray15"),
      strip.text = element_text(color = "white"),
      plot.margin = unit(c(.5,0.1,.5,0.1), "cm"))
}
```

```{r}
exports |> spline_plot(15)
```

```{r}
ggsave(here("Econometrics", "Results", "RFE and SIM over time (exports).png"), 
       width = 13, height = 6, dpi = 300, units = "in")
```

```{r}
imports |> spline_plot(15)
```

```{r}
ggsave(here("Econometrics", "Results", "RFE and SIM over time (imports).png"), 
       width = 13, height = 6, dpi = 300, units = "in")
```
