# Econometric estimation

```{r}
pacman::p_load(tidyverse, here, broom, panelr, plm, nlme)
gravity <- read_csv("gravity.csv")
```

#### Params

```{r}
exports <- panel_data(gravity %>% filter(exports > 0), id = iso_j, wave = year)
imports <- panel_data(gravity %>% filter(imports > 0), id = iso_j, wave = year)
```

```{r}
formula_exports <- 
  log(exports) ~ log(tgdp) + rfe + sim + log(dist) + log(rer) + cont + lang + 
  ccol + crel + rta

formula_imports <- 
  log(imports) ~ log(tgdp) + rfe + sim + log(dist) + log(rer) + cont + lang + 
  ccol + crel + rta
```

#### Functions

```{r}
add_name <- 
  function(data, tidy, id) {
    if (tidy == TRUE) {
      data |> 
        add_row(term = id, .before = 1)
    } else {
      data |> 
        mutate(estimator = id) |> 
        relocate(estimator)
    }
  }

tidy_it <- 
  function(data, id) {
  model_tidy <- 
    data |> 
    tidy() |> 
    add_name(tidy = TRUE, 
             id = id)
  
  return(model_tidy)
}

glance_it <- 
  function(data, id) {
  model_glance <- 
    data |> 
    glance() |> 
    add_name(tidy = FALSE, 
             id = id)
  
  return(model_glance)
}
```

#### Random effects estimator

```{r}
exports_ree <- 
  plm(formula_exports,
      data = exports,
      model = "random")

exports_ree |> summary()
```

```{r}
imports_ree <- 
  plm(formula_imports,
      data = imports,
      model = "random")

imports_ree |> summary()
```

```{r}
exports_ree_tidy <- exports_ree |> tidy_it("Random effects (exports)")
exports_ree_glance <- exports_ree |> glance_it("Random effects (exports)")

imports_ree_tidy <- imports_ree |> tidy_it("Random effects (imports)")
imports_ree_glance <- imports_ree |> glance_it("Random effects (imports)")
```

#### Fixed effects estimator

```{r}
exports_fee <- 
  plm(formula_exports,
      data = exports,
      model = "within")

exports_fee |> summary()
```

```{r}
imports_fee <- 
  plm(formula_imports,
      data = imports,
      model = "within")

imports_fee |> summary()
```

```{r}
exports_fee_tidy <- exports_fee |> tidy_it("Fixed effects (exports)")
exports_fee_glance <- exports_fee |> glance_it("Fixed effects (exports)")

imports_fee_tidy <- imports_fee |> tidy_it("Fixed effects (imports)")
imports_fee_glance <- imports_fee |> glance_it("Fixed effects (imports)")
```

#### Poisson pseudo maximum likelihood estimator

```{r}
exports_ppml <- 
  glm(formula_exports,
      family = quasipoisson(link = "log"),
      data = exports)

exports_ppml |> summary()
```

```{r}
imports_ppml <- 
  glm(formula_imports,
      family = quasipoisson(link = "log"),
      data = imports)

imports_ppml |> summary()
```

```{r}
exports_ppml_tidy <- exports_ppml |> tidy_it("PPML (exports)")
exports_ppml_glance <- exports_ppml |> glance_it("PPML (exports)")

imports_ppml_tidy <- imports_ppml |> tidy_it("PPML (imports)")
imports_ppml_glance <- imports_ppml |> glance_it("PPML (imports)")
```

#### Poisson pseudo maximum likelihood with fixed effects estimator

```{r}
formula_exports_fixed <- 
  log(exports) ~ log(tgdp) + rfe + sim + log(dist) + 
  log(rer) + cont + lang + ccol + crel + rta + factor(year)

formula_imports_fixed <- 
  log(imports) ~ log(tgdp) + rfe + sim + log(dist) + 
  log(rer) + cont + lang + ccol + crel + rta + factor(year)
```

```{r}
exports_ppml_fixed <- 
  glm(formula_exports_fixed,
      family = quasipoisson(link = "log"),
      data = exports)

exports_ppml_fixed |> summary()
```

```{r}
imports_ppml_fixed <- 
  glm(formula_imports_fixed,
      family = quasipoisson(link = "log"),
      data = imports)

imports_ppml_fixed |> summary()
```

```{r}
exports_ppml_fixed_tidy <- exports_ppml_fixed |> tidy_it("PPML FE (exports)")
exports_ppml_fixed_glance <- exports_ppml_fixed |> glance_it("PPML FE (exports)")

imports_ppml_fixed_tidy <- imports_ppml_fixed |> tidy_it("PPML FE (imports)")
imports_ppml_fixed_glance <- imports_ppml_fixed |> glance_it("PPML FE (imports)")
```

#### AR(1) estimator

```{r}
exports_ar <- 
  lme(formula_exports,
      data = exports,
      random = ~1|iso_j,
      correlation = corAR1(0, form = ~year|iso_j))

exports_ar |> summary()
```

```{r}
imports_ar <- 
  lme(formula_imports,
      data = imports,
      random = ~1|iso_j,
      correlation = corAR1(0, form = ~year|iso_j))

imports_ar |> summary()
```

#### Writting results

```{r}
exports_ree_tidy |> 
  bind_rows(exports_fee_tidy) |> 
  bind_rows(exports_ppml_tidy) |> 
  bind_rows(exports_ppml_fixed_tidy |> slice(1:12)) |> 
  write_csv(here("Econometrics", "Results", "exports.csv"))

imports_ree_tidy |> 
  bind_rows(imports_fee_tidy) |> 
  bind_rows(imports_ppml_tidy) |> 
  bind_rows(imports_ppml_fixed_tidy |> slice(1:12)) |> 
  write_csv(here("Econometrics", "Results", "imports.csv"))
```
