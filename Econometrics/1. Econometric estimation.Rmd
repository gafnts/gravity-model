# Econometric estimation

```{r}
pacman::p_load(tidyverse, here, broom, panelr, plm, nlme, lmtest, stargazer)
gravity <- read_csv("gravity.csv")
```

#### Params

```{r}
exports <- gravity |> mutate(exports = 1 + exports) |> panel_data(id = iso_j, wave = year)
imports <- gravity |> mutate(imports = 1 + imports) |> panel_data(id = iso_j, wave = year)
```

```{r}
formula_exports <- 
  log(exports) ~ tgdp + rfe + sim + log(dist) + log(rer) + cont + lang + 
  ccol + crel + rta

formula_imports <- 
  log(imports) ~ tgdp + rfe + sim + log(dist) + log(rer) + cont + lang + 
  ccol + crel + rta
```

### Pooled estimator

```{r}
exports_ols <- 
  plm(formula_exports,
      data = exports,
      model = "pooling")

exports_ols |> summary()
```

```{r}
imports_ols <- 
  plm(formula_imports,
      data = imports,
      model = "pooling")

imports_ols |> summary()
```

### Random effects estimator

```{r}
exports_ree <- 
  plm(formula_exports,
      data = exports,
      model = "random")

exports_ree |> summary()
```

```{r}
imports_ree <- 
  plm(formula_imports,
      data = imports,
      model = "random")

imports_ree |> summary()
```

### Fixed effects estimator

```{r}
exports_fee <- 
  plm(formula_exports,
      data = exports,
      model = "within")

exports_fee |> summary()
```

```{r}
imports_fee <- 
  plm(formula_imports,
      data = imports,
      model = "within")

imports_fee |> summary()
```

### Poisson pseudo maximum likelihood estimator

#### Params

```{r}
# Feature engineering
exports_ppml <- 
  gravity |> 
  mutate(exports = ifelse(log(exports) <= 0, 0, log(exports))) |> 
  panel_data(id = iso_j, wave = year)

imports_ppml <- 
  gravity |> 
  mutate(imports = ifelse(log(imports) <= 0, 0, log(imports))) |> 
  panel_data(id = iso_j, wave = year)
```

```{r}
# Just checking 
imports_ppml |> 
  select(year, iso_j, imports) |> 
  filter(if_any(where(is.numeric), ~ .x <= 0))
```

```{r}
# Declaring formulas
formula_exports_ppml <- 
  exports ~ tgdp + rfe + sim + log(dist) + log(rer) + cont + lang + 
  ccol + crel + rta

formula_imports_ppml <- 
  imports ~ tgdp + rfe + sim + log(dist) + log(rer) + cont + lang + 
  ccol + crel + rta
```

#### Estimation

```{r}
ppml_exports <- 
  glm(formula_exports_ppml,
      family = quasipoisson(link = "log"),
      data = exports_ppml)

ppml_exports |> summary()
```

```{r}
ppml_imports <- 
  glm(formula_imports_ppml,
      family = quasipoisson(link = "log"),
      data = imports_ppml)

ppml_imports |> summary()
```

### Results

```{r}
vars <- c("Suma bilateral del producto interno bruto",
          "Diferencia en la proporción relativa de factores",
          "Similitud en el tamaño de las economías",
          "Distancia entre principales centros urbanos",
          "Tipo de cambio efectivo real",
          "Fronteras en común",
          "Lenguaje en común", 
          "Colonizador en común",
          "Índice de similitud en creencias religiosas",
          "Acuerdos comerciales regionales",
          "Constante")
```

```{r}
rob_se_exports <- list(sqrt(diag(vcovHC(exports_ols, type = "HC1"))),
                       sqrt(diag(vcovHC(exports_ree, type = "HC1"))),
                       sqrt(diag(vcovHC(exports_fee, type = "HC1"))),
                       sqrt(diag(vcovHC(ppml_exports, type = "HC1"))))
```

```{r}
# Exports
stargazer(exports_ols, exports_ree, exports_fee, ppml_exports,
          column.labels = c("OLS", "REE", "FEE", "PPML"),
          se = rob_se_exports,
          covariate.labels = vars,
          type = "text",
          dep.var.caption = "",
          dep.var.labels.include = FALSE,
          model.names = FALSE,
          model.numbers = FALSE,
          out = here("Econometrics", "Results", "exports.html"))
```

```{r}
rob_se_imports <- list(sqrt(diag(vcovHC(imports_ols, type = "HC1"))),
                       sqrt(diag(vcovHC(imports_ree, type = "HC1"))),
                       sqrt(diag(vcovHC(imports_fee, type = "HC1"))),
                       sqrt(diag(vcovHC(ppml_imports, type = "HC1"))))
```

```{r}
# Imports
stargazer(imports_ols, imports_ree, imports_fee, ppml_imports,
          column.labels = c("OLS", "REE", "FEE", "PPML"),
          se = rob_se_imports,
          covariate.labels = vars,
          type = "text",
          dep.var.caption = "",
          dep.var.labels.include = FALSE,
          model.names = FALSE,
          model.numbers = FALSE,
          out = here("Econometrics", "Results", "imports.html"))
```
