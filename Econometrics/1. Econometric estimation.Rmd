# Econometric estimation

```{r}
pacman::p_load(tidyverse, here, broom, panelr, plm, nlme, lmtest)
gravity <- read_csv("gravity.csv")
```

#### Functions

```{r}
add_name <- 
  function(data, tidy, id) {
    if (tidy == TRUE) {
      data |> 
        add_row(term = id, .before = 1)
    } else {
      data |> 
        mutate(estimator = id) |> 
        relocate(estimator)
    }
  }

tidy_it <- 
  function(data, id) {
  model_tidy <- 
    data |> 
    tidy() |> 
    add_name(tidy = TRUE, 
             id = id)
  
  return(model_tidy)
}

glance_it <- 
  function(data, id) {
  model_glance <- 
    data |> 
    glance() |> 
    add_name(tidy = FALSE, 
             id = id)
  
  return(model_glance)
}
```

#### Params

```{r}
exports <- gravity |> mutate(exports = 1 + exports) |> panel_data(id = iso_j, wave = year)
imports <- gravity |> mutate(imports = 1 + imports) |> panel_data(id = iso_j, wave = year)
```

```{r}
formula_exports <- 
  log(exports) ~ tgdp + rfe + sim + log(dist) + log(rer) + cont + lang + 
  ccol + crel + rta

formula_imports <- 
  log(imports) ~ tgdp + rfe + sim + log(dist) + log(rer) + cont + lang + 
  ccol + crel + rta
```

### Random effects estimator

```{r}
exports_ree <- 
  plm(formula_exports,
      data = exports,
      model = "random")

exports_ree |> summary()
```

```{r}
imports_ree <- 
  plm(formula_imports,
      data = imports,
      model = "random")

imports_ree |> summary()
```

```{r}
exports_ree_tidy <- exports_ree |> tidy_it("Random effects (exports)")
exports_ree_glance <- exports_ree |> glance_it("Random effects (exports)")

imports_ree_tidy <- imports_ree |> tidy_it("Random effects (imports)")
imports_ree_glance <- imports_ree |> glance_it("Random effects (imports)")
```

### Fixed effects estimator

```{r}
exports_fee <- 
  plm(formula_exports,
      data = exports,
      model = "within")

exports_fee |> summary()
```

```{r}
imports_fee <- 
  plm(formula_imports,
      data = imports,
      model = "within")

imports_fee |> summary()
```

```{r}
exports_fee_tidy <- exports_fee |> tidy_it("Fixed effects (exports)")
exports_fee_glance <- exports_fee |> glance_it("Fixed effects (exports)")

imports_fee_tidy <- imports_fee |> tidy_it("Fixed effects (imports)")
imports_fee_glance <- imports_fee |> glance_it("Fixed effects (imports)")
```

### Fixed effects estimator (twoway)

```{r}
exports_fee_tw <- 
  plm(formula_exports,
      data = exports,
      model = "within",
      effect = "twoways")

exports_fee_tw |> summary()
```

```{r}
imports_fee_tw <- 
  plm(formula_imports,
      data = imports,
      model = "within",
      effect = "twoways")

imports_fee_tw |> summary()
```

```{r}
exports_fee_tw_tidy <- exports_fee_tw |> tidy_it("Fixed time effects (exports)")
exports_fee_tw_glance <- exports_fee_tw |> glance_it("Fixed time effects (exports)")

imports_fee_tw_tidy <- imports_fee_tw |> tidy_it("Fixed time effects (imports)")
imports_fee_tw_glance <- imports_fee_tw |> glance_it("Fixed time effects (imports)")
```

### Poisson pseudo maximum likelihood estimator

#### Params

```{r}
# Feature engineering
exports_ppml <- 
  gravity |> 
  mutate(exports = ifelse(log(exports) <= 0, 0, log(exports))) |> 
  panel_data(id = iso_j, wave = year)

imports_ppml <- 
  gravity |> 
  mutate(imports = ifelse(log(imports) <= 0, 0, log(imports))) |> 
  panel_data(id = iso_j, wave = year)
```

```{r}
# Just checking 
imports_ppml |> 
  select(year, iso_j, imports) |> 
  filter(if_any(where(is.numeric), ~ .x <= 0))
```

```{r}
# Declaring formulas
formula_exports_ppml <- 
  exports ~ tgdp + rfe + sim + log(dist) + log(rer) + cont + lang + 
  ccol + crel + rta

formula_imports_ppml <- 
  imports ~ tgdp + rfe + sim + log(dist) + log(rer) + cont + lang + 
  ccol + crel + rta
```

#### Estimation

```{r}
ppml_exports <- 
  glm(formula_exports_ppml,
      family = quasipoisson(link = "log"),
      data = exports_ppml)

ppml_exports |> summary()
```

```{r}
ppml_imports <- 
  glm(formula_imports_ppml,
      family = quasipoisson(link = "log"),
      data = imports_ppml)

ppml_imports |> summary()
```

```{r}
ppml_exports_tidy <- ppml_exports |> tidy_it("PPML (exports)")
ppml_exports_glance <- ppml_exports |> glance_it("PPML (exports)")

ppml_imports_tidy <- ppml_imports |> tidy_it("PPML (imports)")
ppml_imports_glance <- ppml_imports |> glance_it("PPML (imports)")
```

### Results

```{r}
format <- function(model, name) {
  model |> 
  coeftest(vcov = vcovHC, type = "HC1", cluster = "group") |> 
  tidy() |> 
  select(term, estimate, std.error, p.value) |> 
  pivot_longer(!c(term, p.value)) |> 
  mutate(` ` = case_when(
    p.value >= 0.05 & p.value < 0.1 ~ ".",
    p.value >= 0.01 & p.value < 0.05 ~ "*",
    p.value >= 0.001 & p.value < 0.01 ~ "**",
    p.value < 0.001 ~ "***",
    TRUE ~ ""
  )) |> 
  select(term, name, value, ` `) |> 
  mutate(value = as.character(round(value, 3)),
         value = ifelse(name == "std.error", paste0("(", value, ")"), value),
         term = if_else(row_number() %% 2 == 0, "", term),
         ` ` = if_else(row_number() %% 2 == 0, "", ` `)) |> 
  select(!name) |> 
  rename("Variable" = term,
         name = value)
}
```

```{r}
format(exports_ree, "Efectos aleatorios")
```

```{r}
exports_ree |> 
  coeftest(vcov = vcovHC, type = "HC1", cluster = "group") |> 
  tidy() |> 
  select(term, estimate, std.error, p.value) |> 
  pivot_longer(!c(term, p.value)) |> 
  mutate(` ` = case_when(
    p.value >= 0.05 & p.value < 0.1 ~ ".",
    p.value >= 0.01 & p.value < 0.05 ~ "*",
    p.value >= 0.001 & p.value < 0.01 ~ "**",
    p.value < 0.001 ~ "***",
    TRUE ~ ""
  )) |> 
  select(term, name, value, ` `) |> 
  mutate(value = as.character(round(value, 3)),
         value = ifelse(name == "std.error", paste0("(", value, ")"), value),
         term = if_else(row_number() %% 2 == 0, "", term),
         ` ` = if_else(row_number() %% 2 == 0, "", ` `)) |> 
  select(!name) |> 
  rename("Variable" = term,
         "Efectos aleatorios" = value)
```

### Writting results

```{r}
exports_ree_tidy |> 
  bind_rows(exports_fee_tidy) |> 
  bind_rows(ppml_exports_tidy) |> 
  write_csv(here("Econometrics", "Results", "exports.csv"))

imports_ree_tidy |> 
  bind_rows(imports_fee_tidy) |> 
  bind_rows(ppml_imports_tidy) |> 
  write_csv(here("Econometrics", "Results", "imports.csv"))
```
